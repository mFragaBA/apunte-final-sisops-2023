<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Design of a General Purpose Memory Allocator for the 4.3BSD UNIX Kernel - Notas Final Sistemas Operativos 2023</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">
        <link rel="stylesheet" href="././mdbook-admonish.css">
        <link rel="stylesheet" href="./custom.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduccion.html"><strong aria-hidden="true">1.</strong> Introducción</a></li><li class="chapter-item expanded "><a href="procesos_y_api.html"><strong aria-hidden="true">2.</strong> Procesos y API del SO</a></li><li class="chapter-item expanded "><a href="ipc.html"><strong aria-hidden="true">3.</strong> Intercomunicación Entre Procesos</a></li><li class="chapter-item expanded "><a href="scheduling.html"><strong aria-hidden="true">4.</strong> Scheduling</a></li><li class="chapter-item expanded "><a href="sincro_entre_procesos.html"><strong aria-hidden="true">5.</strong> Sincronización entre procesos</a></li><li class="chapter-item expanded "><a href="sincronizacion.html"><strong aria-hidden="true">6.</strong> Sincronización</a></li><li class="chapter-item expanded "><a href="administracion_de_memoria.html"><strong aria-hidden="true">7.</strong> Administración de Memoria</a></li><li class="chapter-item expanded "><a href="entrada_salida.html"><strong aria-hidden="true">8.</strong> Entrada/Salida</a></li><li class="chapter-item expanded "><a href="sistemas_de_archivos.html"><strong aria-hidden="true">9.</strong> Sistemas de Archivos</a></li><li class="chapter-item expanded "><a href="sistemas_distribuidos.html"><strong aria-hidden="true">10.</strong> Sistemas Distribuidos</a></li><li class="chapter-item expanded "><a href="sistemas_distribuidos_II.html"><strong aria-hidden="true">11.</strong> Sistemas Distribuidos - parte II</a></li><li class="chapter-item expanded "><a href="proteccion_y_seguridad.html"><strong aria-hidden="true">12.</strong> Protección y Seguridad</a></li><li class="chapter-item expanded "><a href="virtualizacion.html"><strong aria-hidden="true">13.</strong> Virtualización</a></li><li class="chapter-item expanded "><a href="microkernels.html"><strong aria-hidden="true">14.</strong> Microkernels</a></li><li class="chapter-item expanded "><a href="misc.html"><strong aria-hidden="true">15.</strong> Miscelaneos</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="memory_allocator_bsd.html" class="active"><strong aria-hidden="true">15.1.</strong> Design of a General Purpose Memory Allocator for the 4.3BSD UNIX Kernel</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Notas Final Sistemas Operativos 2023</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="design-of-a-general-purpose-memory-allocator-for-the-43bsd-unix-kernel"><a class="header" href="#design-of-a-general-purpose-memory-allocator-for-the-43bsd-unix-kernel">Design of a General Purpose Memory Allocator for the 4.3BSD UNIX Kernel</a></h1>
<h2 id="intro"><a class="header" href="#intro">Intro</a></h2>
<p>Setea el contexto actual de los allocators de memoria en BSD. Hasta el
momento venían armando un allocator custom para cada tipo de uso.
Plantean que hay algunas cosas muy importantes que hay que priorizar:</p>
<ul>
<li>Tener un allocator de propósito general</li>
<li>que preserve la misma interfaz de <code>malloc()</code> y <code>free()</code></li>
<li>el <code>malloc()</code> tiene que recibir sólamente el tamaño del cacho del bloque pedido.</li>
<li>el <code>free()</code> sólo tiene que recibir el puntero al inicio del bloque a liberar</li>
</ul>
<h2 id="criterios-para-un-allocator-de-memoria"><a class="header" href="#criterios-para-un-allocator-de-memoria">Criterios para un allocator de memoria</a></h2>
<p>Evalúan la efectividad del algoritmo midiendo la utilización porcentual. Esto es calcular la cantidad de memoria necesaria para cubrir un conjunto de reservas de memoria en cualquier momento. Está dado por:</p>
<p>\[
\text{utilization} = \frac{requested}{required}
\]</p>
<p>Donde \( \text{requested} \) es la suma de la cantidad memoria reservada y todavía no liberada. Por required se refiere a la cantidad de memoria reservada para responder a esos pedidos de memoria (siempre se requiere un poco más para sopesar los problemas de fragmentación y para tener un buffer listo para nuevos pedidos de memoria).</p>
<ul>
<li>En la práctica una utilización del 50% es considerada buena</li>
</ul>
<p>También destaca algunos aspectos/requerimientos importantes de un buen algoritmo de reserva de memoria.</p>
<ul>
<li>Es más importante una buena utilización de memoria en el kernel vs en los procesos de usuario, principalmente porque la memoria de usuario es virtual y siempre podemos sacar páginas.</li>
<li>El algoritmo tiene que ser <strong>rápido</strong>, debido a que es una operación utilizada frecuentemente. Un allocator lento degrada la performance de todo el OS y de lios procesos que corren en el mismo.
<ul>
<li>además un mal allocator va a incentivar a los desarrolladores a crear su propio allocator, reduciendo la efectividad del allocator de propíosito general.</li>
</ul>
</li>
</ul>
<h2 id="implementación-user-level"><a class="header" href="#implementación-user-level">Implementación User-Level</a></h2>
<p>El user-level memory allocator de 4.2BSD mantiene un conjunto de
listas ordenadas según cada potencia de 2 (O sea tengo listas de
bloques de 1 byte, 2 bytes, 4 bytes, 8 bytes, etc. Para satisfacer un
pedido de memoria, redondeo a la mínima potencia de 2 más grande que
el tamaño pedido y le devuelvo ese bloque de memoria. De esa forma
<code>free()</code> sólo tiene que devolver el bloque de memoria al arreglo
correspondiente. Sólo cuando la lista sea vacía, hace un pedido de
memoria posta (al kernel).</p>
<h2 id="consideraciones-de-un-kernel-level-memory-allocator"><a class="header" href="#consideraciones-de-un-kernel-level-memory-allocator">Consideraciones de un Kernel-Level memory allocator</a></h2>
<p>Se asumen algunas suposiciones:</p>
<ul>
<li>el tamaño máximo a reservar está acotado desde el momento del
booteo.
<ul>
<li>de esa forma el kernel crea y mantiene un conjunto estático de
estructuras para manejar la memoria dinámicamente reservada.</li>
</ul>
</li>
<li>el allocator puede manejar su propio espacio de memoria como le
plazca.
<ul>
<li>a diferencia de los user-space que sólo pueden reservar/liberar
memoria para hacer crecer/achicar el heap.</li>
</ul>
</li>
<li>otra suposición es la de conocer de antemano la distribución de los
pedidos de memoria
<ul>
<li>según sus estimaciones, frecuentemente se pide poca memoria, y
poco frecuentemente se pide mucha memoria. Entonces priorizo que
sea rápido para porciones pequeñas de memoria.</li>
</ul>
</li>
</ul>
<h2 id="implementación-de-un-kernel-level-memory-allocator"><a class="header" href="#implementación-de-un-kernel-level-memory-allocator">Implementación de un kernel level memory allocator</a></h2>
<ul>
<li>para pedidos de poca memoria se usa la estrategia de potencias de 2.
<ul>
<li>cuando no hay espacio disponible recién ahí se llama al &quot;allocator
real&quot;</li>
</ul>
</li>
<li>para asegurarse que los pedidos grandes llaman al allocator las
listas de las potencias de 2 grandes siempre están vacías.</li>
<li>idea del allocator posta:
<ul>
<li>se redondea al múltiplo de <code>PAGE_SIZE</code> más cercano. Usa first-fit
para encontrar los bloques.</li>
</ul>
</li>
<li>otra pequeña optimización en pedidos chicos: me traigo una página
entera aunque sobre, la divido y con los que sobran lleno la lista
de potencias de 2 para acelerar pedidos futuros.</li>
<li>Para bloques grandes se guardan en las páginas el tamaño del bloque (esto es necesario porque <code>free()</code> no recibe el tamaño del bloque a liberar).</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="misc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="misc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
